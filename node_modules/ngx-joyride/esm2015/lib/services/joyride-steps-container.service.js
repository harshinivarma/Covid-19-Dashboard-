/**
 * @fileoverview added by tsickle
 * Generated from: lib/services/joyride-steps-container.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { JoyrideOptionsService } from './joyride-options.service';
import { LoggerService } from './logger.service';
import { JoyrideError, JoyrideStepOutOfRange } from '../models/joyride-error.class';
/** @type {?} */
const ROUTE_SEPARATOR = '@';
class Step {
}
if (false) {
    /** @type {?} */
    Step.prototype.id;
    /** @type {?} */
    Step.prototype.step;
}
/** @enum {string} */
const StepActionType = {
    NEXT: "NEXT",
    PREV: "PREV",
};
export { StepActionType };
export class JoyrideStepsContainerService {
    /**
     * @param {?} stepOptions
     * @param {?} logger
     */
    constructor(stepOptions, logger) {
        this.stepOptions = stepOptions;
        this.logger = logger;
        this.tempSteps = [];
        this.currentStepIndex = -2;
        this.stepHasBeenModified = new Subject();
    }
    /**
     * @private
     * @return {?}
     */
    getFirstStepIndex() {
        /** @type {?} */
        const firstStep = this.stepOptions.getFirstStep();
        /** @type {?} */
        const stepIds = this.stepOptions.getStepsOrder();
        /** @type {?} */
        let index = stepIds.indexOf(firstStep);
        if (index < 0) {
            index = 0;
            if (firstStep !== undefined)
                this.logger.warn(`The step ${firstStep} does not exist. Check in your step list if it's present.`);
        }
        return index;
    }
    /**
     * @return {?}
     */
    init() {
        this.logger.info('Initializing the steps array.');
        this.steps = [];
        this.currentStepIndex = this.getFirstStepIndex() - 1;
        /** @type {?} */
        let stepIds = this.stepOptions.getStepsOrder();
        stepIds.forEach((/**
         * @param {?} stepId
         * @return {?}
         */
        stepId => this.steps.push({ id: stepId, step: null })));
    }
    /**
     * @param {?} stepToAdd
     * @return {?}
     */
    addStep(stepToAdd) {
        /** @type {?} */
        let stepExist = this.tempSteps.filter((/**
         * @param {?} step
         * @return {?}
         */
        step => step.name === stepToAdd.name)).length > 0;
        if (!stepExist) {
            this.logger.info(`Adding step ${stepToAdd.name} to the steps list.`);
            this.tempSteps.push(stepToAdd);
        }
        else {
            /** @type {?} */
            let stepIndexToReplace = this.tempSteps.findIndex((/**
             * @param {?} step
             * @return {?}
             */
            step => step.name === stepToAdd.name));
            this.tempSteps[stepIndexToReplace] = stepToAdd;
        }
    }
    /**
     * @param {?} action
     * @return {?}
     */
    get(action) {
        if (action === StepActionType.NEXT)
            this.currentStepIndex++;
        else
            this.currentStepIndex--;
        if (this.currentStepIndex < 0 || this.currentStepIndex >= this.steps.length)
            throw new JoyrideStepOutOfRange('The first or last step of the tour cannot be found!');
        /** @type {?} */
        const stepName = this.getStepName(this.steps[this.currentStepIndex].id);
        /** @type {?} */
        const index = this.tempSteps.findIndex((/**
         * @param {?} step
         * @return {?}
         */
        step => step.name === stepName));
        /** @type {?} */
        let stepFound = this.tempSteps[index];
        this.steps[this.currentStepIndex].step = stepFound;
        if (stepFound == null) {
            this.logger.warn(`Step ${this.steps[this.currentStepIndex].id} not found in the DOM. Check if it's hidden by *ngIf directive.`);
        }
        return stepFound;
    }
    /**
     * @param {?} action
     * @return {?}
     */
    getStepRoute(action) {
        /** @type {?} */
        let stepID;
        if (action === StepActionType.NEXT) {
            stepID = this.steps[this.currentStepIndex + 1] ? this.steps[this.currentStepIndex + 1].id : null;
        }
        else {
            stepID = this.steps[this.currentStepIndex - 1] ? this.steps[this.currentStepIndex - 1].id : null;
        }
        /** @type {?} */
        let stepRoute = stepID && stepID.includes(ROUTE_SEPARATOR) ? stepID.split(ROUTE_SEPARATOR)[1] : '';
        return stepRoute;
    }
    /**
     * @param {?} stepName
     * @param {?} position
     * @return {?}
     */
    updatePosition(stepName, position) {
        /** @type {?} */
        let index = this.getStepIndex(stepName);
        if (this.steps[index].step) {
            this.steps[index].step.position = position;
            this.stepHasBeenModified.next(this.steps[index].step);
        }
        else {
            this.logger.warn(`Trying to modify the position of ${stepName} to ${position}. Step not found!Is this step located in a different route?`);
        }
    }
    /**
     * @param {?} stepName
     * @return {?}
     */
    getStepNumber(stepName) {
        return this.getStepIndex(stepName) + 1;
    }
    /**
     * @return {?}
     */
    getStepsCount() {
        /** @type {?} */
        let stepsOrder = this.stepOptions.getStepsOrder();
        return stepsOrder.length;
    }
    /**
     * @private
     * @param {?} stepName
     * @return {?}
     */
    getStepIndex(stepName) {
        /** @type {?} */
        const index = this.steps
            .map((/**
         * @param {?} step
         * @return {?}
         */
        step => (step.id.includes(ROUTE_SEPARATOR) ? step.id.split(ROUTE_SEPARATOR)[0] : step.id)))
            .findIndex((/**
         * @param {?} name
         * @return {?}
         */
        name => stepName === name));
        if (index === -1)
            throw new JoyrideError(`The step with name: ${stepName} does not exist in the step list.`);
        return index;
    }
    /**
     * @private
     * @param {?} stepID
     * @return {?}
     */
    getStepName(stepID) {
        /** @type {?} */
        let stepName = stepID && stepID.includes(ROUTE_SEPARATOR) ? stepID.split(ROUTE_SEPARATOR)[0] : stepID;
        return stepName;
    }
}
JoyrideStepsContainerService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
JoyrideStepsContainerService.ctorParameters = () => [
    { type: JoyrideOptionsService },
    { type: LoggerService }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    JoyrideStepsContainerService.prototype.steps;
    /**
     * @type {?}
     * @private
     */
    JoyrideStepsContainerService.prototype.tempSteps;
    /**
     * @type {?}
     * @private
     */
    JoyrideStepsContainerService.prototype.currentStepIndex;
    /** @type {?} */
    JoyrideStepsContainerService.prototype.stepHasBeenModified;
    /**
     * @type {?}
     * @private
     */
    JoyrideStepsContainerService.prototype.stepOptions;
    /**
     * @type {?}
     * @private
     */
    JoyrideStepsContainerService.prototype.logger;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiam95cmlkZS1zdGVwcy1jb250YWluZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1qb3lyaWRlLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2pveXJpZGUtc3RlcHMtY29udGFpbmVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDbEUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxZQUFZLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQzs7TUFFOUUsZUFBZSxHQUFHLEdBQUc7QUFFM0IsTUFBTSxJQUFJO0NBR1Q7OztJQUZHLGtCQUFXOztJQUNYLG9CQUFrQjs7O0FBR3RCLE1BQVksY0FBYztJQUN0QixJQUFJLFFBQVM7SUFDYixJQUFJLFFBQVM7RUFDaEI7O0FBR0QsTUFBTSxPQUFPLDRCQUE0Qjs7Ozs7SUFNckMsWUFBNkIsV0FBa0MsRUFBbUIsTUFBcUI7UUFBMUUsZ0JBQVcsR0FBWCxXQUFXLENBQXVCO1FBQW1CLFdBQU0sR0FBTixNQUFNLENBQWU7UUFKL0YsY0FBUyxHQUFrQixFQUFFLENBQUM7UUFDOUIscUJBQWdCLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDOUIsd0JBQW1CLEdBQXlCLElBQUksT0FBTyxFQUFlLENBQUM7SUFFbUMsQ0FBQzs7Ozs7SUFFbkcsaUJBQWlCOztjQUNmLFNBQVMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRTs7Y0FDM0MsT0FBTyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxFQUFFOztZQUU1QyxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFT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LENBQUM7SUFDcEIsQ0FBQzs7O1lBdEdKLFVBQVU7Ozs7WUFoQkYscUJBQXFCO1lBQ3JCLGFBQWE7Ozs7Ozs7SUFpQmxCLDZDQUFzQjs7Ozs7SUFDdEIsaURBQXNDOzs7OztJQUN0Qyx3REFBOEI7O0lBQzlCLDJEQUF1RTs7Ozs7SUFFM0QsbURBQW1EOzs7OztJQUFFLDhDQUFzQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgSm95cmlkZVN0ZXAgfSBmcm9tICcuLi9tb2RlbHMvam95cmlkZS1zdGVwLmNsYXNzJztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBKb3lyaWRlT3B0aW9uc1NlcnZpY2UgfSBmcm9tICcuL2pveXJpZGUtb3B0aW9ucy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTG9nZ2VyU2VydmljZSB9IGZyb20gJy4vbG9nZ2VyLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBKb3lyaWRlRXJyb3IsIEpveXJpZGVTdGVwT3V0T2ZSYW5nZSB9IGZyb20gJy4uL21vZGVscy9qb3lyaWRlLWVycm9yLmNsYXNzJztcclxuXHJcbmNvbnN0IFJPVVRFX1NFUEFSQVRPUiA9ICdAJztcclxuXHJcbmNsYXNzIFN0ZXAge1xyXG4gICAgaWQ6IHN0cmluZztcclxuICAgIHN0ZXA6IEpveXJpZGVTdGVwO1xyXG59XHJcblxyXG5leHBvcnQgZW51bSBTdGVwQWN0aW9uVHlwZSB7XHJcbiAgICBORVhUID0gJ05FWFQnLFxyXG4gICAgUFJFViA9ICdQUkVWJ1xyXG59XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBKb3lyaWRlU3RlcHNDb250YWluZXJTZXJ2aWNlIHtcclxuICAgIHByaXZhdGUgc3RlcHM6IFN0ZXBbXTtcclxuICAgIHByaXZhdGUgdGVtcFN0ZXBzOiBKb3lyaWRlU3RlcFtdID0gW107XHJcbiAgICBwcml2YXRlIGN1cnJlbnRTdGVwSW5kZXggPSAtMjtcclxuICAgIHN0ZXBIYXNCZWVuTW9kaWZpZWQ6IFN1YmplY3Q8Sm95cmlkZVN0ZXA+ID0gbmV3IFN1YmplY3Q8Sm95cmlkZVN0ZXA+KCk7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBzdGVwT3B0aW9uczogSm95cmlkZU9wdGlvbnNTZXJ2aWNlLCBwcml2YXRlIHJlYWRvbmx5IGxvZ2dlcjogTG9nZ2VyU2VydmljZSkge31cclxuXHJcbiAgICBwcml2YXRlIGdldEZpcnN0U3RlcEluZGV4KCk6IG51bWJlciB7XHJcbiAgICAgICAgY29uc3QgZmlyc3RTdGVwID0gdGhpcy5zdGVwT3B0aW9ucy5nZXRGaXJzdFN0ZXAoKTtcclxuICAgICAgICBjb25zdCBzdGVwSWRzID0gdGhpcy5zdGVwT3B0aW9ucy5nZXRTdGVwc09yZGVyKCk7XHJcblxyXG4gICAgICAgIGxldCBpbmRleCA9IHN0ZXBJZHMuaW5kZXhPZihmaXJzdFN0ZXApO1xyXG4gICAgICAgIGlmIChpbmRleCA8IDApIHtcclxuICAgICAgICAgICAgaW5kZXggPSAwO1xyXG4gICAgICAgICAgICBpZiAoZmlyc3RTdGVwICE9PSB1bmRlZmluZWQpIHRoaXMubG9nZ2VyLndhcm4oYFRoZSBzdGVwICR7Zmlyc3RTdGVwfSBkb2VzIG5vdCBleGlzdC4gQ2hlY2sgaW4geW91ciBzdGVwIGxpc3QgaWYgaXQncyBwcmVzZW50LmApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGluZGV4O1xyXG4gICAgfVxyXG5cclxuICAgIGluaXQoKSB7XHJcbiAgICAgICAgdGhpcy5sb2dnZXIuaW5mbygnSW5pdGlhbGl6aW5nIHRoZSBzdGVwcyBhcnJheS4nKTtcclxuICAgICAgICB0aGlzLnN0ZXBzID0gW107XHJcbiAgICAgICAgdGhpcy5jdXJyZW50U3RlcEluZGV4ID0gdGhpcy5nZXRGaXJzdFN0ZXBJbmRleCgpIC0gMTtcclxuICAgICAgICBsZXQgc3RlcElkcyA9IHRoaXMuc3RlcE9wdGlvbnMuZ2V0U3RlcHNPcmRlcigpO1xyXG4gICAgICAgIHN0ZXBJZHMuZm9yRWFjaChzdGVwSWQgPT4gdGhpcy5zdGVwcy5wdXNoKHsgaWQ6IHN0ZXBJZCwgc3RlcDogbnVsbCB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgYWRkU3RlcChzdGVwVG9BZGQ6IEpveXJpZGVTdGVwKSB7XHJcbiAgICAgICAgbGV0IHN0ZXBFeGlzdCA9IHRoaXMudGVtcFN0ZXBzLmZpbHRlcihzdGVwID0+IHN0ZXAubmFtZSA9PT0gc3RlcFRvQWRkLm5hbWUpLmxlbmd0aCA+IDA7XHJcbiAgICAgICAgaWYgKCFzdGVwRXhpc3QpIHtcclxuICAgICAgICAgICAgdGhpcy5sb2dnZXIuaW5mbyhgQWRkaW5nIHN0ZXAgJHtzdGVwVG9BZGQubmFtZX0gdG8gdGhlIHN0ZXBzIGxpc3QuYCk7XHJcbiAgICAgICAgICAgIHRoaXMudGVtcFN0ZXBzLnB1c2goc3RlcFRvQWRkKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsZXQgc3RlcEluZGV4VG9SZXBsYWNlID0gdGhpcy50ZW1wU3RlcHMuZmluZEluZGV4KHN0ZXAgPT4gc3RlcC5uYW1lID09PSBzdGVwVG9BZGQubmFtZSk7XHJcbiAgICAgICAgICAgIHRoaXMudGVtcFN0ZXBzW3N0ZXBJbmRleFRvUmVwbGFjZV0gPSBzdGVwVG9BZGQ7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgZ2V0KGFjdGlvbjogU3RlcEFjdGlvblR5cGUpOiBKb3lyaWRlU3RlcCB7XHJcbiAgICAgICAgaWYgKGFjdGlvbiA9PT0gU3RlcEFjdGlvblR5cGUuTkVYVCkgdGhpcy5jdXJyZW50U3RlcEluZGV4Kys7XHJcbiAgICAgICAgZWxzZSB0aGlzLmN1cnJlbnRTdGVwSW5kZXgtLTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuY3VycmVudFN0ZXBJbmRleCA8IDAgfHwgdGhpcy5jdXJyZW50U3RlcEluZGV4ID49IHRoaXMuc3RlcHMubGVuZ3RoKVxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgSm95cmlkZVN0ZXBPdXRPZlJhbmdlKCdUaGUgZmlyc3Qgb3IgbGFzdCBzdGVwIG9mIHRoZSB0b3VyIGNhbm5vdCBiZSBmb3VuZCEnKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc3RlcE5hbWUgPSB0aGlzLmdldFN0ZXBOYW1lKHRoaXMuc3RlcHNbdGhpcy5jdXJyZW50U3RlcEluZGV4XS5pZCk7XHJcbiAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLnRlbXBTdGVwcy5maW5kSW5kZXgoc3RlcCA9PiBzdGVwLm5hbWUgPT09IHN0ZXBOYW1lKTtcclxuICAgICAgICBsZXQgc3RlcEZvdW5kID0gdGhpcy50ZW1wU3RlcHNbaW5kZXhdO1xyXG4gICAgICAgIHRoaXMuc3RlcHNbdGhpcy5jdXJyZW50U3RlcEluZGV4XS5zdGVwID0gc3RlcEZvdW5kO1xyXG5cclxuICAgICAgICBpZiAoc3RlcEZvdW5kID09IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy5sb2dnZXIud2FybihgU3RlcCAke3RoaXMuc3RlcHNbdGhpcy5jdXJyZW50U3RlcEluZGV4XS5pZH0gbm90IGZvdW5kIGluIHRoZSBET00uIENoZWNrIGlmIGl0J3MgaGlkZGVuIGJ5ICpuZ0lmIGRpcmVjdGl2ZS5gKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBzdGVwRm91bmQ7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U3RlcFJvdXRlKGFjdGlvbjogU3RlcEFjdGlvblR5cGUpIHtcclxuICAgICAgICBsZXQgc3RlcElEOiBzdHJpbmc7XHJcbiAgICAgICAgaWYgKGFjdGlvbiA9PT0gU3RlcEFjdGlvblR5cGUuTkVYVCkge1xyXG4gICAgICAgICAgICBzdGVwSUQgPSB0aGlzLnN0ZXBzW3RoaXMuY3VycmVudFN0ZXBJbmRleCArIDFdID8gdGhpcy5zdGVwc1t0aGlzLmN1cnJlbnRTdGVwSW5kZXggKyAxXS5pZCA6IG51bGw7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgc3RlcElEID0gdGhpcy5zdGVwc1t0aGlzLmN1cnJlbnRTdGVwSW5kZXggLSAxXSA/IHRoaXMuc3RlcHNbdGhpcy5jdXJyZW50U3RlcEluZGV4IC0gMV0uaWQgOiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgc3RlcFJvdXRlID0gc3RlcElEICYmIHN0ZXBJRC5pbmNsdWRlcyhST1VURV9TRVBBUkFUT1IpID8gc3RlcElELnNwbGl0KFJPVVRFX1NFUEFSQVRPUilbMV0gOiAnJztcclxuXHJcbiAgICAgICAgcmV0dXJuIHN0ZXBSb3V0ZTtcclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVQb3NpdGlvbihzdGVwTmFtZTogc3RyaW5nLCBwb3NpdGlvbjogc3RyaW5nKSB7XHJcbiAgICAgICAgbGV0IGluZGV4ID0gdGhpcy5nZXRTdGVwSW5kZXgoc3RlcE5hbWUpO1xyXG4gICAgICAgIGlmICh0aGlzLnN0ZXBzW2luZGV4XS5zdGVwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3RlcHNbaW5kZXhdLnN0ZXAucG9zaXRpb24gPSBwb3NpdGlvbjtcclxuICAgICAgICAgICAgdGhpcy5zdGVwSGFzQmVlbk1vZGlmaWVkLm5leHQodGhpcy5zdGVwc1tpbmRleF0uc3RlcCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5sb2dnZXIud2FybihcclxuICAgICAgICAgICAgICAgIGBUcnlpbmcgdG8gbW9kaWZ5IHRoZSBwb3NpdGlvbiBvZiAke3N0ZXBOYW1lfSB0byAke3Bvc2l0aW9ufS4gU3RlcCBub3QgZm91bmQhSXMgdGhpcyBzdGVwIGxvY2F0ZWQgaW4gYSBkaWZmZXJlbnQgcm91dGU/YFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGdldFN0ZXBOdW1iZXIoc3RlcE5hbWU6IHN0cmluZyk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U3RlcEluZGV4KHN0ZXBOYW1lKSArIDE7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U3RlcHNDb3VudCgpIHtcclxuICAgICAgICBsZXQgc3RlcHNPcmRlciA9IHRoaXMuc3RlcE9wdGlvbnMuZ2V0U3RlcHNPcmRlcigpO1xyXG4gICAgICAgIHJldHVybiBzdGVwc09yZGVyLmxlbmd0aDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFN0ZXBJbmRleChzdGVwTmFtZTogc3RyaW5nKTogbnVtYmVyIHtcclxuICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMuc3RlcHNcclxuICAgICAgICAgICAgLm1hcChzdGVwID0+IChzdGVwLmlkLmluY2x1ZGVzKFJPVVRFX1NFUEFSQVRPUikgPyBzdGVwLmlkLnNwbGl0KFJPVVRFX1NFUEFSQVRPUilbMF0gOiBzdGVwLmlkKSlcclxuICAgICAgICAgICAgLmZpbmRJbmRleChuYW1lID0+IHN0ZXBOYW1lID09PSBuYW1lKTtcclxuICAgICAgICBpZiAoaW5kZXggPT09IC0xKSB0aHJvdyBuZXcgSm95cmlkZUVycm9yKGBUaGUgc3RlcCB3aXRoIG5hbWU6ICR7c3RlcE5hbWV9IGRvZXMgbm90IGV4aXN0IGluIHRoZSBzdGVwIGxpc3QuYCk7XHJcbiAgICAgICAgcmV0dXJuIGluZGV4O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0U3RlcE5hbWUoc3RlcElEOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIGxldCBzdGVwTmFtZSA9IHN0ZXBJRCAmJiBzdGVwSUQuaW5jbHVkZXMoUk9VVEVfU0VQQVJBVE9SKSA/IHN0ZXBJRC5zcGxpdChST1VURV9TRVBBUkFUT1IpWzBdIDogc3RlcElEO1xyXG4gICAgICAgIHJldHVybiBzdGVwTmFtZTtcclxuICAgIH1cclxufVxyXG4iXX0=